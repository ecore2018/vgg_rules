vgg_rules
==============

This is an experimental project for implementing rule engine(business_rule) in Python.

The project is a console application based on Django 1.6, implementing promotion calculations in business system:
* All goods are priced individually. Some items are also multi-priced based on quantity bought. Buy n of them, and theyâ€™ll cost you y cents.
* Pricing changes frequently
* Items could have multiple rules

The rule script in json format is saved in database and will be read and implemented to all the items ordered.

Rule Script Examples:

The "name" in "condtions" is defined in python class `OrderDetailVariables`. The "name" in "action" is defined in python class `OrderDetailActions`.

1. Buy 3 oranges in a group at price $1.80 each(10% off).

```json

{ "conditions": { "all": [
      { "name": "product_code",
        "operator": "equal_to",
        "value": "ORANGE"
      },
      { "name": "product_amount",
        "operator": "greater_than_or_equal_to",
        "value": 3
      }
  ]},
  "actions": [
      { "name": "buy_group_and_cheaper",
        "params": {"group_count": 3,  "sale_price": 180}
      }
  ]
}
```

2. Buy 5 apple, get 2 free

```json
{ "conditions": { "all": [
      { "name": "product_code",
        "operator": "equal_to",
        "value": "APPLE"
      },
      { "name": "product_amount",
        "operator": "greater_than_or_equal_to",
        "value": 5
      }
  ]},
  "actions": [
      { "name": "buy_and_get_cheaper",
        "params": {"buy_count": 5,  "cheaper_count": 2, "sale_percentage": 0}
      }
  ]
}
```


## Command Usage

### 1. Create a new order

This command will create a new order.

`$ python manage.py createorder`


### 2. Purchase Items

This command will add item to specified order. If the same item has been added, the amount will add up.

`$ python manage.py additem <order_number> <product_code> <amount>`



Order Count: 2
Order Num: 6QIE1405909818 | Status: Checkout(1) | Date: 2014-07-21 02:30:18+00:00
Order Num: WIY51405918562 | Status: New(0) | Date: 2014-07-21 04:56:02+00:00


Order Number: WIY51405918562
REGLR PRICE  3800.00
PRMTN PRICE  3120.00
================= ITEMS ==============
CODE:APPLE     NAME:red apple
REGLR PRICE  2000.00
PRMTN PRICE  1500.00
Promotion APPLE2_1
Buy 5 apple, get 2 free
-----------------------------
CODE:ORANGE     NAME:big orange
REGLR PRICE  1800.00
PRMTN PRICE  1620.00
Promotion ORANGE_3
Buy 3 oranges in a group at price $1.80 each(10% off)
-----------------------------




For example:

```python
class ProductActions(BaseActions):

    def __init__(self, product):
        self.product = product

    @rule_action(params={"sale_percentage": FIELD_NUMERIC})
    def put_on_sale(self, sale_percentage):
        self.product.price = (1.0 - sale_percentage) * self.product.price
        self.product.save()

    @rule_action(params={"number_to_order": FIELD_NUMERIC})
    def order_more(self, number_to_order):
        ProductOrder.objects.create(product_id=self.product.id,
                                    quantity=number_to_order)
```

### 3. Build the rules

A rule is just a JSON object that gets interpreted by the business-rules engine.

Note that the JSON is expected to be auto-generated by a UI, which makes it simple for anyone to set and tweak business rules without knowing anything about the code.  The javascript library used for generating these on the web can be found here: [here](https://github.com/chrisjpowers/business-rules).

An example of the resulting python lists/dicts is:

```python
rules = [
# expiration_days < 5 AND current_inventory > 20
{ "conditions": { "all": [
      { "name": "expiration_days",
        "operator": "less_than",
        "value": "5",
      },
      { "name": "current_inventory",
        "operator": "greater_than",
        "value": "20",
      },
  ]},
  "actions": [
      { "name": "put_on_sale",
        "fields": [{"name": "sale_percentage", "value": 0.25}],
      },
  ],
},

# current_inventory < 5 OR (current_month = "December" AND current_inventory < 20)
{ "conditions": { "any": [
      { "name": "current_inventory",
        "operator": "less_than",
        "value": 5,
      },
    ]},
      { "all": [
        {  "name": "current_month",
          "operator": "equals",
          "value": "December",
        },
        { "name": "goes_well_with",
          "operator": "shares_at_least_one_element_with",
          "value": ["eggnog", "sugar cookies"],
        }
      ]},
  },
  "actions": [
    { "name": "order_more",
      "fields":[{"name":"number_to_order", "value": 40}]}
  ]
}]
```

### Export the available variables, operators and actions

To e.g. send to your client so it knows how to build rules

```python
from business_rules import export_rule_data
export_rule_data(ProductVariables, ProductActions)
```

that returns

```python
{"variables": [
    { "name": "expiration_days",
      "label": "Days until expiration",
      "field_type": "numeric",
      "options": []},
    { "name": "current_month",
      "label": "Current Month",
      "field_type": "string",
      "options": []},
    { "name": "goes_well_with",
      "label": "Goes Well With",
      "field_type": "select",
      "options": ["Eggnog", "Cookies", "Beef Jerkey"]}
                ],
  "actions": [
    { "name": "put_on_sale",
      "label": "Put On Sale",
      "params": {"sale_percentage": "numeric"}},
    { "name": "order_more",
      "label": "Order More",
      "params": {"number_to_order": "numeric"}}
  ],
  "variable_type_operators": {
    "numeric": [ {"name": "equal_to",
                  "label": "Equal To",
                  "input_type": "numeric"},
                 {"name": "less_than",
                  "label": "Less Than",
                  "input_type": "numeric"},
                 {"name": "greater_than",
                  "label": "Greater Than",
                  "input_type": "numeric"}],
    "string": [ { "name": "equal_to",
                  "label": "Equal To",
                  "input_type": "text"},
                { "name": "non_empty",
                  "label": "Non Empty",
                  "input_type": "none"}]
  }
}
```

### Run your rules

```python
from business_rules import run_all

rules = _some_function_to_receive_from_client()

for product in Products.objects.all():
    run_all(rules=rules,
            variables=ProductVariables(product),
            actions=ProductActions(product),
            stop_on_first_trigger=True
           )
```

## API

#### Variable Types and Decorators:

The type represents the type of the value that will be returned for the variable and is necessary since there are different available comparison operators for different types, and the front-end that's generating the rules needs to know which operators are available.

All decorators can optionally take the arguments:
- `label` - A human-readable label to show on the frontend. By default we just split the variable name on underscores and capitalize the words.
- `cache_result` - Whether to cache the value of the variable for this instance of the variable container object. Defaults to `True` (to avoid re-doing expensive DB queries or computations if you have many rules based on the same variables).

The available types and decorators are:

**numeric** - an integer, float, or python Decimal.

`@numeric_rule_variable` operators:

* `equal_to`
* `greater_than`
* `less_than`
* `greater_than_or_equal_to`
* `less_than_or_equal_to`

Note: to compare floating point equality we just check that the difference is less than some small epsilon

**string** - a python bytestring or unicode string.

`@string_rule_variable` operators:

* `equal_to`
* `starts_with`
* `ends_with`
* `contains`
* `matches_regex`
* `non_empty`

**boolean** - a True or False value.

`@boolean_rule_variable` operators:

* `is_true`
* `is_false`

**select** - a set of values, where the threshold will be a single item.

`@select_rule_variable` operators:

* `contains`
* `does_not_contain`

**select_multiple** - a set of values, where the threshold will be a set of items.

`@select_multiple_rule_variable` operators:

* `contains_all`
* `is_contained_by`
* `shares_at_least_one_element_with`
* `shares_exactly_one_element_with`
* `shares_no_elements_with`

### Returning data to your client


